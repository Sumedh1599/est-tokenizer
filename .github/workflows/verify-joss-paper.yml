name: Verify JOSS Paper
on:
  push:
    branches: [ main ]
    paths:
      - 'paper.md'
      - 'paper.bib'
  pull_request:
    branches: [ main ]
    paths:
      - 'paper.md'
      - 'paper.bib'

jobs:
  verify-paper:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for paper files
        run: |
          echo "üìÑ Checking for JOSS paper files..."
          
          # Check if paper.md exists
          if [ ! -f "paper.md" ]; then
            echo "‚ùå ERROR: paper.md not found!"
            echo "JOSS submission requires a paper.md file in the root directory"
            echo "See: https://joss.readthedocs.io/en/latest/submitting.html"
            exit 1
          else
            echo "‚úÖ paper.md found"
          fi
          
          # Check if paper.bib exists (warning only)
          if [ ! -f "paper.bib" ]; then
            echo "‚ö†Ô∏è WARNING: paper.bib not found"
            echo "Consider adding a bibliography file for references"
          else
            echo "‚úÖ paper.bib found"
          fi

      - name: Validate paper structure
        run: |
          echo "üîç Validating paper structure..."
          
          # Check for YAML frontmatter
          if ! head -1 paper.md | grep -q "---"; then
            echo "‚ùå ERROR: YAML frontmatter missing"
            echo "JOSS papers must start with YAML frontmatter (---)"
            exit 1
          fi
          
          echo "‚úÖ YAML frontmatter found"
          
          # Extract YAML content (between --- markers)
          sed -n '/^---$/,/^---$/p' paper.md > frontmatter.yaml
          
          # Check for required YAML fields
          REQUIRED_FIELDS=("title" "authors" "affiliations" "keywords" "date")
          for field in "${REQUIRED_FIELDS[@]}"; do
            if grep -q "^$field:" frontmatter.yaml; then
              echo "‚úÖ '$field' field found"
            else
              echo "‚ùå '$field' field missing in YAML frontmatter"
            fi
          done

      - name: Check word count
        run: |
          echo "üìä Checking word count..."
          
          # Extract content between YAML blocks (excluding code blocks)
          sed '1,/^---$/d' paper.md | sed -n '/^---$/q;p' > content.md
          
          # Remove code blocks
          sed -i '/^```/,/^```/d' content.md
          
          # Count words
          WORD_COUNT=$(wc -w < content.md)
          echo "Word count: $WORD_COUNT"
          
          # JOSS guidelines: 250-1000 words
          if [ $WORD_COUNT -lt 250 ]; then
            echo "‚ö†Ô∏è WARNING: Paper is too short (< 250 words)"
            echo "JOSS recommends 250-1000 words"
          elif [ $WORD_COUNT -gt 1000 ]; then
            echo "‚ö†Ô∏è WARNING: Paper is long (> 1000 words)"
            echo "JOSS recommends keeping it concise"
          else
            echo "‚úÖ Word count within recommended range (250-1000 words)"
          fi

      - name: Check for figures and citations
        run: |
          echo "üñºÔ∏è Checking for figures and citations..."
          
          # Count figures
          FIGURE_COUNT=$(grep -c '!\[.*\](.*)' paper.md || true)
          echo "Figures found: $FIGURE_COUNT"
          
          # Check for citations
          if [ -f "paper.bib" ]; then
            CITATION_COUNT=$(grep -c '@' paper.md || true)
            echo "Citations in paper: $CITATION_COUNT"
            
            BIB_ENTRIES=$(grep -c '@' paper.bib || true)
            echo "References in paper.bib: $BIB_ENTRIES"
          fi

      - name: Create summary report
        run: |
          echo "üìã JOSS Paper Validation Summary"
          echo "================================"
          echo ""
          echo "Basic checks passed! ‚úÖ"
          echo ""
          echo "Next steps for JOSS submission:"
          echo "1. Ensure all required YAML fields are filled"
          echo "2. Add ORCID IDs for authors (recommended)"
          echo "3. Include a statement of need"
          echo "4. Add references to related work"
          echo "5. Describe the software functionality"
          echo ""
          echo "See JOSS documentation:"
          echo "https://joss.readthedocs.io/en/latest/submitting.html"
