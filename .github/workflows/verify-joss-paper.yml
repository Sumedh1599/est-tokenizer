name: Verify JOSS Paper

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  verify:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Verify JOSS Paper Structure
      run: |
        echo "=========================================="
        echo "JOSS PAPER STRUCTURE VERIFICATION"
        echo "=========================================="
        
        # Check if paper.md exists
        if [ ! -f "paper.md" ]; then
          echo "‚ùå ERROR: paper.md not found"
          exit 1
        fi
        echo "‚úÖ paper.md exists"
        
        # Check YAML header starts with ---
        if ! head -1 paper.md | grep -q "---"; then
          echo "‚ùå ERROR: paper.md must start with '---'"
          exit 1
        fi
        echo "‚úÖ YAML header starts correctly"
        
        # Check required sections
        REQUIRED_SECTIONS=6
        SECTION_COUNT=$(grep -c "^# " paper.md)
        if [ $SECTION_COUNT -lt $REQUIRED_SECTIONS ]; then
          echo "‚ùå ERROR: Found only $SECTION_COUNT sections, need at least $REQUIRED_SECTIONS"
          exit 1
        fi
        echo "‚úÖ Found $SECTION_COUNT sections"
        
        # Check specific required sections
        for section in "Summary" "Statement of Need" "Key Features" "Methodology" "Benchmark Results" "Availability"; do
          if ! grep -q "^# $section" paper.md; then
            echo "‚ùå ERROR: Missing '# $section' section"
            exit 1
          fi
        done
        echo "‚úÖ All required sections present"
        
        # Check paper.bib exists
        if [ ! -f "paper.bib" ]; then
          echo "‚ùå ERROR: paper.bib not found"
          exit 1
        fi
        echo "‚úÖ paper.bib exists"
        
        # Check BibTeX entries
        BIB_ENTRIES=$(grep -c "^@" paper.bib || echo "0")
        if [ "$BIB_ENTRIES" -eq "0" ]; then
          echo "‚ùå ERROR: No BibTeX entries found in paper.bib"
          exit 1
        fi
        echo "‚úÖ Found $BIB_ENTRIES BibTeX entries"
        
        # Check ORCID
        if ! grep -q "orcid:" paper.md; then
          echo "‚ö†Ô∏è  WARNING: No ORCID found in paper.md"
        else
          echo "‚úÖ ORCID found"
        fi
        
        echo ""
        echo "üéâ ALL CHECKS PASSED!"
        echo "Your paper is ready for JOSS submission."
        
    - name: Compile Paper (Optional - Tests PDF generation)
      if: success()
      uses: openjournals/joss-paper-compiler@main
      with:
        paper-path: paper.md
        bibliography-path: paper.bib
        
    - name: Upload Compiled Paper
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: compiled-paper
        path: paper.pdf
